"use server";

import { revalidatePath } from "next/cache";
import { ContactMessage, Product } from "./model";
import { connectToDB } from "./utils";

export async function addProduct(prevState: any, formData: FormData) {
  const data = Object.fromEntries(formData.entries());
  const formDataJsonString = JSON.stringify(data);

  try {
    const uri = process.env.API_URL || "";
    const endpoint = "products";

    const res = await fetch(uri + endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
        //Authorization: `Bearer ${API_TOKEN}`,
      },
      body: formDataJsonString,
    });

    revalidatePath("/");

    return {
      message: "Se ha guardado el producto",
    };
  } catch (err) {
    console.log(err);
    throw new Error("Failed to save product!");
  }
}

export async function addContactMessage(prevState: any, formData: FormData) {
  const { name, email, telephone, message } = Object.fromEntries(formData);

  try {
    connectToDB();
    const newMessage = new ContactMessage({
      name,
      email,
      telephone,
      message,
    });

    await newMessage.save();
  } catch (error) {
    console.log(error);
    throw new Error("Error al guardar el mensaje");
  }

  //redirect("/");
  return {
    message: "Se ha guardado el mensaje",
  };
}
